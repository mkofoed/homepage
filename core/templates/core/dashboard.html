{% extends 'core/base.html' %}

{% block title %}Dashboard - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Hero Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold mb-2">Live Dashboard</h1>
            <p class="lead text-muted">Real-time server metrics updated every 5 seconds</p>
        </div>

        <!-- Metrics Cards -->
        <div class="row g-4 mb-5">
            <!-- CPU Usage -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100 bg-dark">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="bi bi-cpu display-4 text-primary"></i>
                        </div>
                        <h5 class="fw-bold mb-3">CPU Usage</h5>
                        <div id="cpu-metric" class="display-5 fw-bold text-primary">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted">Percentage</small>
                    </div>
                </div>
            </div>

            <!-- Memory Usage -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100 bg-dark">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="bi bi-memory display-4 text-success"></i>
                        </div>
                        <h5 class="fw-bold mb-3">Memory Usage</h5>
                        <div id="memory-metric" class="display-5 fw-bold text-success">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted" id="memory-detail">Loading...</small>
                    </div>
                </div>
            </div>

            <!-- Database Response -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100 bg-dark">
                    <div class="card-body text-center p-4">
                        <div class="mb-3">
                            <i class="bi bi-database display-4 text-info"></i>
                        </div>
                        <h5 class="fw-bold mb-3">Database Latency</h5>
                        <div id="db-metric" class="display-5 fw-bold text-info">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                        </div>
                        <small class="text-muted">Milliseconds</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Memory Progress Bar -->
        <div class="card shadow-sm mb-5 bg-dark">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>Memory Utilization</h5>
                <div class="progress" style="height: 30px; background-color: rgba(255,255,255,0.1);">
                    <div id="memory-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;">
                        <span id="memory-bar-text" class="fw-bold">Loading...</span>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2 text-muted small">
                    <span id="memory-used">0 MB used</span>
                    <span id="memory-total">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="card shadow-sm bg-dark">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-3"><i class="bi bi-info-circle me-2 text-primary"></i>About This Dashboard</h5>
                <p class="text-muted mb-0">
                    This dashboard demonstrates real-time data updates using <strong>HTMX polling</strong> â€”
                    a simpler alternative to WebSockets. The metrics are fetched from the server every 5 seconds
                    and rendered client-side. No JavaScript frameworks required!
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // Fetch and update metrics
    function updateMetrics() {
        fetch('{% url "metrics" %}')
            .then(response => response.json())
            .then(data => {
                // CPU
                document.getElementById('cpu-metric').textContent = data.cpu_percent.toFixed(1) + '%';

                // Memory
                document.getElementById('memory-metric').textContent = data.memory_percent.toFixed(1) + '%';
                document.getElementById('memory-detail').textContent =
                    data.memory_used_mb.toFixed(0) + ' / ' + data.memory_total_mb.toFixed(0) + ' MB';

                // Memory bar
                const memBar = document.getElementById('memory-bar');
                memBar.style.width = data.memory_percent + '%';
                document.getElementById('memory-bar-text').textContent = data.memory_percent.toFixed(1) + '%';

                // Color coding for memory
                memBar.className = 'progress-bar';
                if (data.memory_percent > 80) {
                    memBar.classList.add('bg-danger');
                } else if (data.memory_percent > 60) {
                    memBar.classList.add('bg-warning');
                } else {
                    memBar.classList.add('bg-success');
                }

                document.getElementById('memory-used').textContent = data.memory_used_mb.toFixed(0) + ' MB used';
                document.getElementById('memory-total').textContent = data.memory_total_mb.toFixed(0) + ' MB total';

                // Database
                document.getElementById('db-metric').textContent = data.db_response_ms + 'ms';
            })
            .catch(err => console.error('Failed to fetch metrics:', err));
    }

    // Initial load
    updateMetrics();

    // Poll every 5 seconds
    setInterval(updateMetrics, 5000);
</script>
{% endblock %}